<!--
  ~ Copyright 2011 Leonid Maslov<leonidms@gmail.com>
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<atlassian-plugin key="${project.groupId}.${project.artifactId}" name="${project.name}" plugins-version="2">
    <plugin-info>
        <description>${project.description}</description>
        <version>${project.version}</version>
        <vendor name="${project.organization.name}" url="${project.organization.url}"/>
    </plugin-info>

    <resource type="i18n" name="i18n" location="i18n/messages"/>

    <rest key="runner-output" name="REST Cli API" path="/rest-scripting" version="1.0"
          description="Provides REST CLI endpoints for ${project.name}.">
        <package>com.blogspot.leonardinius.rest.service</package>
    </rest>

    <component-import key="applicationProperties" interface="com.atlassian.sal.api.ApplicationProperties"/>
    <component-import key="userManager" interface="com.atlassian.sal.api.user.UserManager"/>
    <component-import key="webSudoManager" interface="com.atlassian.sal.api.websudo.WebSudoManager"/>
    <component-import key="loginUriProvider" interface="com.atlassian.sal.api.auth.LoginUriProvider"/>
    <component-import key="templateRenderer" interface="com.atlassian.templaterenderer.TemplateRenderer"/>


    <component key="script-service"
               name="Script Service"
               public="true"
               interface="com.blogspot.leonardinius.api.ScriptService"
               class="com.blogspot.leonardinius.api.impl.ScriptServiceImpl">
        <description>Provides script registration capabilities on top of javax.script.ScriptEngineManager</description>
    </component>
    <component key="cli-session-manager" name="Script Service" public="false"
               interface="com.blogspot.leonardinius.api.ScriptSessionManager"
               class="com.blogspot.leonardinius.api.impl.ScriptSessionManagerImpl">
        <description>Implements CLI session management</description>
    </component>
    <component key="rhino-registrar" name="Rhino Registrar" public="false"
               interface="com.blogspot.leonardinius.api.Registrar"
               class="com.blogspot.leonardinius.api.impl.RhinoRegistrarImpl">
        <description>Provides Javascript Rhino (bundled with Sun/Oracle JDK)</description>
    </component>

    <web-resource key="cli-js-css" name="jquery-console javascript and css resources">
        <dependency>com.atlassian.auiplugin:ajs</dependency>
        <resource type="download" name="cli.css" location="cli/cli.css">
            <property key="content-type" value="text/css"/>
            <property key="charset" value="utf-8"/>
        </resource>

        <resource type="download" name="jquery.console.js" location="jquery-console/jquery.console.js">
            <property key="content-type" value="text/javascript"/>
            <property key="charset" value="utf-8"/>
        </resource>
        <resource type="download" name="cli.js" location="cli/cli.js">
            <property key="content-type" value="text/javascript"/>
            <property key="charset" value="utf-8"/>
        </resource>
    </web-resource>

    <web-section key="jira-cli-web-section"
                 name="CLI Section" location="system.admin"
                 system="true" weight="101" application="jira">
        <label key="cli.web.section.title"/>
        <conditions type="OR">
            <condition class="com.atlassian.jira.plugin.webfragment.conditions.UserIsSysAdminCondition"/>
        </conditions>
    </web-section>

    <web-item key="jira-exec-runner-web-item"
              name="Script executor" section="system.admin/jira-cli-web-section"
              weight="20" application="jira">
        <label key="cli.web.section.runner_link"/>
        <link linkId="jira_rest_exec_runner">/secure/admin/restCli!exec.jspa?atl_token=${atl_token}</link>
        <conditions type="OR">
            <condition class="com.atlassian.jira.plugin.webfragment.conditions.UserIsSysAdminCondition"/>
        </conditions>
    </web-item>

    <web-item key="jira-cli-runner-web-item" name="Script CLI"
              section="system.admin/jira-cli-web-section"
              weight="10" application="jira">
        <label key="cli.web.section.cli_link"/>
        <link linkId="jira_rest_cli_runner">/plugins/servlet/rest-script-runner/action/list-sessions.html?atl_token=${atl_token}</link>
        <conditions type="OR">
            <condition class="com.atlassian.jira.plugin.webfragment.conditions.UserIsSysAdminCondition"/>
        </conditions>
    </web-item>

    <web-item key="confluence-exec-runner-web-item" name="Script executor" section="system.admin"
              weight="20" application="confluence">
        <label key="cli.web.section.runner_link"/>
        <link linkId="confluence_rest_exec_runner">/secure/admin/restCli!exec.jspa?atl_token=${atl_token}</link>
    </web-item>

    <web-item key="confluence-cli-runner-web-item" name="Script CLI" section="system.admin"
              weight="10" application="confluence">
        <label key="cli.web.section.cli_link"/>
        <link linkId="confluence_rest_cli_runner">/plugins/servlet/rest-script-runner/action/list-sessions.html?atl_token=${atl_token}
        </link>
    </web-item>

    <!--<webwork1 key="cli-actions" name="CLI Webwork Action" class="java.lang.Object">-->
    <!--<actions>-->
    <!--<action name="com.blogspot.leonardinius.actions.ScriptRunnerAction"-->
    <!--alias="restCli">-->
    <!--<view name="exec">/templates/exec-input.vm</view>-->
    <!--<view name="list">/templates/cli-list.vm</view>-->
    <!--<view name="cli">/templates/cli-input.vm</view>-->
    <!--</action>-->
    <!--</actions>-->
    <!--</webwork1>-->
    <servlet name="Script Runner Web-interface" key="script-runner-servlet"
             class="com.blogspot.leonardinius.servlet.ScriptRunnerSessionServlet">
        <description>Script Runner Web-interface.</description>
        <url-pattern>/rest-script-runner/action/*</url-pattern>
        <init-param>
            <param-name>velocity-templates</param-name>
            <param-value>execute-statement.html|/templates/exec-input.vm;
                list-sessions.html|/templates/cli-list.vm;
                cli-live-session.html|/templates/cli-input.vm
            </param-value>
        </init-param>
    </servlet>

    <template-context-item
            key="script-runner-resource-context-item"
            class="com.blogspot.leonardinius.rest.service.ScriptRunner"
            context-key="scriptRunnerResource"/>
    <template-context-item key="applicationPropertiesContextItem" component-ref="applicationProperties"
                           context-key="applicationProperties" name="Application Properties Context Item"/>
</atlassian-plugin>